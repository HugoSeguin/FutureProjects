<html>
<head>
<title>main.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
main.py</font>
</center></td></tr></table>
<pre><span class="s0">#Import Data</span>
<span class="s2">import </span><span class="s1">matplotlib.pyplot </span><span class="s2">as </span><span class="s1">plt</span>
<span class="s2">import </span><span class="s1">fitbit</span>
<span class="s0">#pip install CherryPy</span>
<span class="s2">import </span><span class="s1">cherrypy </span><span class="s2">as </span><span class="s1">cherrypy</span>
<span class="s0"># gather_keys_oauth2.py file needs to be in the same directory.</span>
<span class="s0"># also needs to install cherrypy: https://pypi.org/project/CherryPy/</span>
<span class="s0"># pip install CherryPy</span>
<span class="s2">import </span><span class="s1">gather_keys_oauth2 </span><span class="s2">as </span><span class="s1">Oauth2</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">datetime</span>

<span class="s0"># YOU NEED TO PUT IN YOUR OWN CLIENT_ID AND CLIENT_SECRET###################</span>
<span class="s0">### Goal is to collect Fitbit 2###############!!!!!!!!!!!!!</span>
<span class="s1">CLIENT_ID = </span><span class="s3">'2388YN'</span>
<span class="s1">CLIENT_SECRET = </span><span class="s3">'0598f271ffd8c0fb83611d79d4134daa'</span>

<span class="s0">#API Authorization</span>
<span class="s1">server = Oauth2.OAuth2Server(CLIENT_ID</span><span class="s2">, </span><span class="s1">CLIENT_SECRET)</span>
<span class="s1">server.browser_authorize()</span>
<span class="s1">ACCESS_TOKEN = str(server.fitbit.client.session.token[</span><span class="s3">'access_token'</span><span class="s1">])</span>
<span class="s1">REFRESH_TOKEN = str(server.fitbit.client.session.token[</span><span class="s3">'refresh_token'</span><span class="s1">])</span>
<span class="s1">auth2_client = fitbit.Fitbit(CLIENT_ID</span><span class="s2">, </span><span class="s1">CLIENT_SECRET</span><span class="s2">, </span><span class="s1">oauth2=</span><span class="s2">True, </span><span class="s1">access_token=ACCESS_TOKEN</span><span class="s2">,</span><span class="s1">refresh_token=REFRESH_TOKEN)</span>

<span class="s1">ACCESS_TOKEN = </span><span class="s3">'eyJhbGciOiJIUzI1NiJ9.' </span><span class="s1">\</span>
               <span class="s3">'eyJhdWQiOiIyMzg4WU4iLCJzdWIiOiI5Tkc0M0IiLCJpc3MiOiJGaXRiaXQiLCJ0eXAiOiJhY2Nlc3N' </span><span class="s1">\</span>
               <span class="s3">'fdG9rZW4iLCJzY29wZXMiOiJyc29jIHJhY3QgcnNldCBybG9jIHJ3ZWkgcmhyIHJwcm8gcm51dCByc2' </span><span class="s1">\</span>
               <span class="s3">'xlIiwiZXhwIjoxNjcwOTc3MjU4LCJpYXQiOjE2NzA5NDg0NTh9.fDcFwBwynPpRVJ3cn44fPYz_c6E_' </span><span class="s1">\</span>
               <span class="s3">'5ozjmMK4yp7RXZE'</span>
<span class="s1">REFRESH_TOKEN = </span><span class="s3">&quot;353c354a8bbd8cca2f8b2dd13a251f9eea1bea515ed7758ac114ca841b46f3e9&quot;</span>

<span class="s0">#5 a.) Get One day of Data##################################################################################################</span>
<span class="s0"># You will have to modify this</span>
<span class="s0"># depending on when you started to use a fitbit</span>
<span class="s0">#################################################Modify this as need a date actually collected data</span>
<span class="s1">oneDate = pd.datetime(year=</span><span class="s4">2022</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">11</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">10</span><span class="s1">)</span>
<span class="s1">help(auth2_client.intraday_time_series)</span>
<span class="s1">oneDayData = auth2_client.intraday_time_series(</span><span class="s3">'activities/heart'</span><span class="s2">,</span>
<span class="s1">base_date = oneDate</span><span class="s2">,</span>
<span class="s1">detail_level = </span><span class="s3">'1sec'</span><span class="s1">)</span>
<span class="s0">#oneDayData</span>
<span class="s1">df = pd.DataFrame(oneDayData[</span><span class="s3">'activities-heart-intraday'</span><span class="s1">][</span><span class="s3">'dataset'</span><span class="s1">])</span>
<span class="s0"># Look at the first 5 rows of the pandas DataFrame</span>
<span class="s1">df.head()</span>
<span class="s0"># The first part gets a date in a string format of YYYY-MM-DD</span>
<span class="s1">filename = oneDayData[</span><span class="s3">'activities-heart'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'dateTime'</span><span class="s1">] + </span><span class="s3">'_intradata'</span>

<span class="s0"># Export file to csv</span>
<span class="s1">df.to_csv(filename + </span><span class="s3">'.csv'</span><span class="s2">, </span><span class="s1">index=</span><span class="s2">False</span><span class="s1">)</span>
<span class="s1">df.to_excel(filename + </span><span class="s3">'.xlsx'</span><span class="s2">, </span><span class="s1">index=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s0">## 5b.) Get Multiple Days of Data</span>
<span class="s0"># startTime is first date of data that I want.</span>
<span class="s0"># You will need to modify for the date you want your data to start</span>
<span class="s1">startTime = pd.datetime(year=</span><span class="s4">2022</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">11</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">21</span><span class="s1">)</span>
<span class="s1">endTime = pd.datetime.today().date() - datetime.timedelta(days=</span><span class="s4">20</span><span class="s1">)</span>
<span class="s1">date_list = []</span>
<span class="s1">df_list = []</span>
<span class="s1">allDates = pd.date_range(start=startTime</span><span class="s2">, </span><span class="s1">end=endTime)</span>

<span class="s2">for </span><span class="s1">oneDate </span><span class="s2">in </span><span class="s1">allDates:</span>
    <span class="s1">oneDate = oneDate.date().strftime(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>

<span class="s1">oneDayData = auth2_client.intraday_time_series(</span><span class="s3">'activities/heart'</span><span class="s2">, </span><span class="s1">base_date=oneDate</span><span class="s2">, </span><span class="s1">detail_level=</span><span class="s3">'1sec'</span><span class="s1">)</span>

<span class="s1">df = pd.DataFrame(oneDayData[</span><span class="s3">'activities-heart-intraday'</span><span class="s1">][</span><span class="s3">'dataset'</span><span class="s1">])</span>

<span class="s1">date_list.append(oneDate)</span>

<span class="s1">df_list.append(df)</span>

<span class="s1">final_df_list = []</span>

<span class="s2">for </span><span class="s1">date</span><span class="s2">, </span><span class="s1">df </span><span class="s2">in </span><span class="s1">zip(date_list</span><span class="s2">, </span><span class="s1">df_list):</span>
    <span class="s2">if </span><span class="s1">len(df) == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s2">continue</span>

<span class="s1">df.loc[:</span><span class="s2">, </span><span class="s3">'date'</span><span class="s1">] = pd.to_datetime(date)</span>

<span class="s1">final_df_list.append(df)</span>

<span class="s1">final_df = pd.concat(final_df_list</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>

<span class="s0">## Optional Making of the data have more detailed timestamp (day and hour instead of day)</span>
<span class="s1">hoursDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.hour.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(hours=x))</span>
<span class="s1">minutesDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.minute.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(minutes=x))</span>
<span class="s1">secondsDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.second.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(seconds=x))</span>

<span class="s0"># Getting the date to also have the time of the day</span>
<span class="s1">final_df[</span><span class="s3">'date'</span><span class="s1">] = final_df[</span><span class="s3">'date'</span><span class="s1">] + hoursDelta + minutesDelta + secondsDelta</span>
<span class="s1">final_df.tail()</span>
<span class="s1">filename = </span><span class="s3">'all_intradata'</span>
<span class="s1">final_df.to_csv(filename + </span><span class="s3">'.csv'</span><span class="s2">, </span><span class="s1">index=</span><span class="s2">False</span><span class="s1">)</span>






<span class="s0">###6.) Try to Graph Intraday Data</span>
<span class="s0"># this is bad as time is duplicated over many days fixing the date column will fix the problem</span>
<span class="s1">final_df.plot(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s3">'value'</span><span class="s1">)</span>
<span class="s0"># The code below is not efficient as I call to_datetime twice</span>
<span class="s1">hoursDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.hour.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(hours=x))</span>
<span class="s1">minutesDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.minute.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(minutes=x))</span>
<span class="s1">secondsDelta = pd.to_datetime(final_df.loc[:</span><span class="s2">, </span><span class="s3">'time'</span><span class="s1">]).dt.second.apply(</span><span class="s2">lambda </span><span class="s1">x: datetime.timedelta(seconds=x))</span>
<span class="s0"># Getting the date to also have the time of the day</span>
<span class="s1">final_df[</span><span class="s3">'date'</span><span class="s1">] = final_df[</span><span class="s3">'date'</span><span class="s1">] + hoursDelta + minutesDelta + secondsDelta</span>
<span class="s0"># final_df['temp_value'] = final_df['value'] + random.randint(-2, 2)</span>
<span class="s0"># this fixed the problem.</span>
<span class="s1">final_df.plot(</span><span class="s3">'date'</span><span class="s2">, </span><span class="s3">'value'</span><span class="s1">)</span>
<span class="s1">plt.legend(</span><span class="s3">''</span><span class="s1">)</span>
<span class="s0">## Looking at a couple days only.</span>
<span class="s1">startDate = pd.datetime(year=</span><span class="s4">2019</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">12</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">24</span><span class="s1">)</span>
<span class="s1">lastDate = pd.datetime(year=</span><span class="s4">2019</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">12</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">27</span><span class="s1">)</span>

<span class="s1">coupledays_df = final_df.loc[final_df.loc[:</span><span class="s2">, </span><span class="s3">'date'</span><span class="s1">].between(startDate</span><span class="s2">, </span><span class="s1">lastDate)</span><span class="s2">, </span><span class="s1">:]</span>
<span class="s1">coupledays_df</span>
<span class="s0"># Just checking the number of the rows</span>
<span class="s1">coupledays_df.shape()</span>
<span class="s1">coupledays_df.plot(</span><span class="s3">'date'</span><span class="s2">, </span><span class="s3">'value'</span><span class="s1">)</span>
<span class="s1">plt.legend(</span><span class="s3">''</span><span class="s1">)</span>
<span class="s1">fig</span><span class="s2">, </span><span class="s1">ax = plt.subplots(figsize=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">7</span><span class="s1">))</span>

<span class="s0"># Taken from: https://stackoverflow.com/questions/16266019/python-pandas-group-datetime-column-into-hour-and-minute-aggregations</span>
<span class="s1">times = pd.to_datetime(coupledays_df[</span><span class="s3">'date'</span><span class="s1">])</span>
<span class="s1">coupledays_df.groupby([times.dt.date</span><span class="s2">, </span><span class="s1">times.dt.hour]).value.mean().plot(ax=ax)</span>

<span class="s1">ax.grid(</span><span class="s2">True,</span>
<span class="s1">axis = </span><span class="s3">'both'</span><span class="s2">,</span>
<span class="s1">zorder = </span><span class="s4">0</span><span class="s2">,</span>
<span class="s1">linestyle = </span><span class="s3">':'</span><span class="s2">,</span>
<span class="s1">color = </span><span class="s3">'k'</span><span class="s1">)</span>
<span class="s1">ax.tick_params(axis=</span><span class="s3">'both'</span><span class="s2">, </span><span class="s1">rotation=</span><span class="s4">45</span><span class="s2">, </span><span class="s1">labelsize=</span><span class="s4">20</span><span class="s1">)</span>
<span class="s1">ax.set_xlabel(</span><span class="s3">'Date, Hour'</span><span class="s2">, </span><span class="s1">fontsize=</span><span class="s4">24</span><span class="s1">)</span>
<span class="s1">ax.set_ylabel(</span><span class="s3">'Heart Rate'</span><span class="s2">, </span><span class="s1">fontsize=</span><span class="s4">24</span><span class="s1">)</span>
<span class="s1">fig.tight_layout()</span>
<span class="s1">fig.savefig(</span><span class="s3">'coupledaysavergedByMin.png'</span><span class="s2">, </span><span class="s1">format=</span><span class="s3">'png'</span><span class="s2">, </span><span class="s1">dpi=</span><span class="s4">300</span><span class="s1">)</span>



<span class="s0">#####7.) Resting Heart Rate</span>
<span class="s0"># startTime is first date of data that I want.</span>
<span class="s0"># You will need to modify for the date you want your data to start</span>
<span class="s1">startTime = pd.datetime(year=</span><span class="s4">2020</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">endTime = pd.datetime.today().date() - datetime.timedelta(days=</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">date_list = []</span>
<span class="s1">resting_list = []</span>

<span class="s1">allDates = pd.date_range(start=startTime</span><span class="s2">, </span><span class="s1">end=endTime)</span>

<span class="s2">for </span><span class="s1">oneDate </span><span class="s2">in </span><span class="s1">allDates:</span>
    <span class="s1">oneDate = oneDate.date().strftime(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>

<span class="s1">oneDayData = auth2_client.intraday_time_series(</span><span class="s3">'activities/heart'</span><span class="s2">, </span><span class="s1">base_date=oneDate</span><span class="s2">, </span><span class="s1">detail_level=</span><span class="s3">'1sec'</span><span class="s1">)</span>

<span class="s1">date_list.append(oneDate)</span>

<span class="s1">resting_list.append(oneDayData[</span><span class="s3">'activities-heart'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'value'</span><span class="s1">][</span><span class="s3">'restingHeartRate'</span><span class="s1">])</span>
<span class="s1">fig</span><span class="s2">, </span><span class="s1">ax = plt.subplots(figsize=(</span><span class="s4">10</span><span class="s2">, </span><span class="s4">7</span><span class="s1">))</span>

<span class="s1">ax.plot(date_list</span><span class="s2">, </span><span class="s1">resting_list)</span>

<span class="s0"># This is just making it so there isnt a grid line or text for every point</span>
<span class="s1">xtick_list = []</span>
<span class="s1">xticklabel_list = []</span>
<span class="s2">for </span><span class="s1">index</span><span class="s2">, </span><span class="s1">label </span><span class="s2">in </span><span class="s1">enumerate(ax.get_xticklabels()):</span>
    <span class="s2">if </span><span class="s1">index % </span><span class="s4">5 </span><span class="s1">== </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s1">xticklabel_list.append(label)</span>
        <span class="s1">xtick_list.append(index)</span>

<span class="s1">ax.grid(</span><span class="s2">True,</span>
        <span class="s1">axis=</span><span class="s3">'both'</span><span class="s2">,</span>
        <span class="s1">zorder=</span><span class="s4">0</span><span class="s2">,</span>
        <span class="s1">linestyle=</span><span class="s3">':'</span><span class="s2">,</span>
        <span class="s1">color=</span><span class="s3">'k'</span><span class="s1">)</span>
<span class="s1">ax.tick_params(axis=</span><span class="s3">'both'</span><span class="s2">, </span><span class="s1">labelsize=</span><span class="s4">20</span><span class="s1">)</span>
<span class="s1">ax.set_xticks(xtick_list)</span>
<span class="s1">ax.tick_params(axis=</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">rotation=</span><span class="s4">90</span><span class="s2">, </span><span class="s1">labelsize=</span><span class="s4">20</span><span class="s1">)</span>
<span class="s1">ax.set_xlim(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">index)</span>
<span class="s0"># ax.set_xticklabels(ax.get_xticklabels(),rotation = 45, rotation_mode=&quot;anchor&quot;, ha = 'right')</span>
<span class="s1">ax.set_xlabel(</span><span class="s3">'Date'</span><span class="s2">, </span><span class="s1">fontsize=</span><span class="s4">24</span><span class="s1">)</span>
<span class="s1">ax.set_ylabel(</span><span class="s3">'Resting Heart Rate'</span><span class="s2">, </span><span class="s1">fontsize=</span><span class="s4">24</span><span class="s1">)</span>
<span class="s1">fig.tight_layout()</span>
<span class="s1">fig.savefig(</span><span class="s3">'restingHR_graph.png'</span><span class="s2">, </span><span class="s1">format=</span><span class="s3">'png'</span><span class="s2">, </span><span class="s1">dpi=</span><span class="s4">300</span><span class="s1">)</span>
<span class="s1">resting_df = pd.DataFrame({</span><span class="s3">'date'</span><span class="s1">: date_list</span><span class="s2">, </span><span class="s3">'RHR'</span><span class="s1">: resting_list})</span>
<span class="s1">resting_df.head()</span>



<span class="s0">##8.) Get Sleep Data</span>
<span class="s1">startTime = pd.datetime(year=</span><span class="s4">2020</span><span class="s2">, </span><span class="s1">month=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">day=</span><span class="s4">5</span><span class="s1">)</span>
<span class="s1">endTime = pd.datetime.today().date() - datetime.timedelta(days=</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">allDates = pd.date_range(start=startTime</span><span class="s2">, </span><span class="s1">end=endTime)</span>
<span class="s1">date_list = []</span>
<span class="s1">df_list = []</span>
<span class="s1">stages_df_list = []</span>

<span class="s1">allDates = pd.date_range(start=startTime</span><span class="s2">, </span><span class="s1">end=endTime)</span>

<span class="s2">for </span><span class="s1">oneDate </span><span class="s2">in </span><span class="s1">allDates:</span>
    <span class="s1">oneDate = oneDate.date().strftime(</span><span class="s3">&quot;%Y-%m-%d&quot;</span><span class="s1">)</span>

<span class="s1">oneDayData = auth2_client.sleep(date=oneDate)</span>

<span class="s0"># get number of minutes for each stage of sleep and such.</span>
<span class="s1">stages_df = pd.DataFrame(oneDayData[</span><span class="s3">'summary'</span><span class="s1">])</span>

<span class="s1">df = pd.DataFrame(oneDayData[</span><span class="s3">'sleep'</span><span class="s1">][</span><span class="s4">0</span><span class="s1">][</span><span class="s3">'minuteData'</span><span class="s1">])</span>

<span class="s1">date_list.append(oneDate)</span>

<span class="s1">df_list.append(df)</span>

<span class="s1">stages_df_list.append(stages_df)</span>

<span class="s1">final_df_list = []</span>

<span class="s1">final_stages_df_list = []</span>

<span class="s2">for </span><span class="s1">date</span><span class="s2">, </span><span class="s1">df</span><span class="s2">, </span><span class="s1">stages_df </span><span class="s2">in </span><span class="s1">zip(date_list</span><span class="s2">, </span><span class="s1">df_list</span><span class="s2">, </span><span class="s1">stages_df_list):</span>
    <span class="s2">if </span><span class="s1">len(df) == </span><span class="s4">0</span><span class="s1">:</span>
        <span class="s2">continue</span>

<span class="s1">df.loc[:</span><span class="s2">, </span><span class="s3">'date'</span><span class="s1">] = pd.to_datetime(date)</span>

<span class="s1">stages_df.loc[:</span><span class="s2">, </span><span class="s3">'date'</span><span class="s1">] = pd.to_datetime(date)</span>

<span class="s1">final_df_list.append(df)</span>
<span class="s1">final_stages_df_list.append(stages_df)</span>

<span class="s1">final_df = pd.concat(final_df_list</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>

<span class="s1">final_stages_df = pd.concat(final_stages_df_list</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
<span class="s1">columns = final_stages_df.columns[~final_stages_df.columns.isin([</span><span class="s3">'date'</span><span class="s1">])].values</span>
<span class="s1">columns</span>
<span class="s1">pd.concat([final_stages_df[columns] + </span><span class="s4">2</span><span class="s2">, </span><span class="s1">final_stages_df[[</span><span class="s3">'date'</span><span class="s1">]]]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
<span class="s0"># Export file to csv</span>
<span class="s1">final_df.to_csv(</span><span class="s3">'minuteSleep' </span><span class="s1">+ </span><span class="s3">'.csv'</span><span class="s2">, </span><span class="s1">index=</span><span class="s2">False</span><span class="s1">)</span>
<span class="s1">final_stages_df.to_csv(</span><span class="s3">'minutesStagesSleep' </span><span class="s1">+ </span><span class="s3">'.csv'</span><span class="s2">, </span><span class="s1">index=</span><span class="s2">True</span><span class="s1">)</span></pre>
</body>
</html>